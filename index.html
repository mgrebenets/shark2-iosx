<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Shark2-iosx : Build Shark 2.3.4 framework for iOS and OSX" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Shark2-iosx</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/mgrebenets/shark2-iosx">View on GitHub</a>

          <h1 id="project_title">Shark2-iosx</h1>
          <h2 id="project_tagline">Build Shark 2.3.4 framework for iOS and OSX</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/mgrebenets/shark2-iosx/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/mgrebenets/shark2-iosx/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h2>
<a name="what-is-shark" class="anchor" href="#what-is-shark"><span class="octicon octicon-link"></span></a>What is Shark?</h2>

<p>SHARK provides libraries for the design of adaptive systems, including methods for linear and nonlinear optimization (e.g., evolutionary and gradient-based algorithms), kernel-based algorithms and neural networks, and other machine learning techniques.</p>

<p>This script is created to build framework for Shark version 2.3.4.</p>

<p>For a newer alpha release of Shark 3.0 please visit <a href="http://image.diku.dk/shark">http://image.diku.dk/shark</a>.</p>

<p>Unlike the GitHub project <a href="https://github.com/mgrebenets/shark2-iosx">README</a> this post goes into details of the build process.</p>

<h2>
<a name="steps" class="anchor" href="#steps"><span class="octicon octicon-link"></span></a>Steps</h2>

<p>The process of building framework consists of the following steps</p>

<ul>
<li>Get Source Code</li>
<li>Patch Source Code</li>
<li>Configure and Build</li>
<li>Lipo Library</li>
<li>Package Framework</li>
</ul><h3>
<a name="get-source-code" class="anchor" href="#get-source-code"><span class="octicon octicon-link"></span></a>Get Source Code</h3>

<p>This step is as simple as just downloading the zip archive.</p>

<div class="highlight highlight-bash"><pre><span class="c"># download</span>
curl -L --progress-bar -o shark-2.3.4.zip <span class="s2">"http://sourceforge.net/projects/shark-project/files/Shark%20Core/Shark%202.3.4/shark-2.3.4.zip/download"</span>

<span class="c"># unzip</span>
unzip -q shark-2.3.4.zip -d src
</pre></div>

<h3>
<a name="patch-source-code" class="anchor" href="#patch-source-code"><span class="octicon octicon-link"></span></a>Patch Source Code</h3>

<p>That's where some fun begins. The original source code was developed with gcc 4.2, while we're trying to compile it with clang 5.0. There's been years of development since then, both in terms of compilers and C++ standards. No wonder clang fails with quite a few errors.</p>

<h4>
<a name="default-constructor" class="anchor" href="#default-constructor"><span class="octicon octicon-link"></span></a>Default Constructor</h4>

<p>Let's start with the patch that I believe might have some impact on the way you should use the library. In file <code>ReClam/EarlyStopping.cpp</code>, line 78.</p>

<div class="highlight highlight-c++"><pre><span class="n">EarlyStopping</span><span class="o">::</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">sl</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>

<p>Note the use of default value for the only parameter of the constructor. There's an in-depth discussion of this issue on <a href="http://stackoverflow.com/questions/18313509/default-argument-gcc-vs-clang">StackOverflow</a></p>

<p>The fix is to remove default value for <code>sl</code> parameter. Since <code>EarlyStopping</code> constructor is not referenced anywhere in the library source code it is up to you, as a library user, to provide some value to it and not to rely on any default values.</p>

<h4>
<a name="no-finite-for-ios" class="anchor" href="#no-finite-for-ios"><span class="octicon octicon-link"></span></a>No 'finite' for iOS</h4>

<p>Next issue is with <code>finite</code> method. This method is not included for iOS target architectures. You will get this error when building both for iOS Device and Simulator. Here's <a href="http://createdigitalnoise.com/discussion/1754/can-t-compile-expr-with-xcode-4-5-2-same-project-works-in-xcode-4-4-1">some referencee</a> to this problem.</p>

<p>The suggested fix is to replace calls to <code>finite</code> with <code>isfinite</code>. The best way to do it is to use <code>#define</code> macro and place it in the <code>SharkDefs.h</code> file.</p>

<div class="highlight highlight-c++"><pre><span class="cp">#if defined(__APPLE__) &amp;&amp; defined(__MACH__)</span>
<span class="cm">/* Apple OSX and iOS (Darwin). */</span>
<span class="cp">#include &lt;TargetConditionals.h&gt;</span>
<span class="cp">#if TARGET_IPHONE_SIMULATOR == 1</span>
<span class="cm">/* iOS in Xcode simulator */</span>
<span class="cp">#define finite(x) isfinite(x)</span>
<span class="cp">#elif TARGET_OS_IPHONE == 1</span>
<span class="cm">/* iOS on iPhone, iPad, etc. */</span>
<span class="cp">#define finite(x) isfinite(x)</span>
<span class="c1">// #define drem(x, y) remainder(x, y)</span>
<span class="cp">#elif TARGET_OS_MAC == 1</span>
<span class="cm">/* OSX */</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
</pre></div>

<ul>
<li>First, check if <code>__APPLE__</code> and <code>__MACH___</code> are defined to detect Apple's OS.</li>
<li>Then include <code>&lt;TargetConditionals.&gt;</code> to enable <code>TARGET_IPHONE_SIMULATOR</code>, <code>TARGET_OS_IPHONE</code> and <code>TARGET_OS_MAC</code> defines.</li>
<li>Finally, use those three defines to redefine <code>finite(x)</code> as <code>isfinite(x)</code> for iOS Device and Simulator targets.</li>
</ul><p>Note the commented line for <code>drem(x, y)</code>. This method is not available for iOS targets as well and should be replaced with <code>remainder(x, y)</code>. Shark library doesn't use it, but you'll know what to do if you ever have a problem with <code>drem</code>.</p>

<h4>
<a name="fileutil-fixes" class="anchor" href="#fileutil-fixes"><span class="octicon octicon-link"></span></a>FileUtil Fixes</h4>

<p>Next comes <code>FileUtil.h</code>. There's a couple of things that clang doesn't like.</p>

<p>First is the use of <code>FileUtil</code> namespace. Clang can't resolve references to <code>iotype</code> type, as well as references to three constants <code>SetDefault</code>, <code>ScanFrom</code> and <code>PrintTo</code>.</p>

<p>The fix is to use namespace scope.</p>

<div class="highlight highlight-c++"><pre><span class="n">iotype</span> <span class="o">--&gt;</span> <span class="n">FileUtil</span><span class="o">::</span><span class="n">iotype</span>
<span class="n">SetDefault</span> <span class="o">--&gt;</span> <span class="n">FileUtil</span><span class="o">::</span><span class="n">SetDefault</span>
<span class="n">ScanFrom</span> <span class="o">--&gt;</span> <span class="n">FileUtil</span><span class="o">::</span><span class="n">ScanFrom</span>
<span class="n">PrintTo</span> <span class="o">--&gt;</span> <span class="n">FileUtil</span><span class="o">::</span><span class="n">PrintTo</span>
</pre></div>

<p>Finally, <code>io_strict</code> is calling <code>scanFrom_strict</code> and <code>printTo_strict</code>, which are defined further down in the header file.</p>

<p>The fix for this problem is simple - move declaration of <code>io_strict</code> to the bottom of the header file.</p>

<h4>
<a name="double-erfdouble-throw" class="anchor" href="#double-erfdouble-throw"><span class="octicon octicon-link"></span></a>double erf(double) throw();</h4>

<p>Compilation of <code>Mixture/MixtureOfGaussians.cpp</code> fails with error caused by the following line</p>

<div class="highlight highlight-c++"><pre><span class="k">extern</span> <span class="s">"C"</span> <span class="kt">double</span> <span class="n">erf</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="k">throw</span><span class="p">();</span>
</pre></div>

<p>Clang complains that <code>extern "C"</code> declaration doesn't match the actual prototype of <code>erf</code>. Removing <code>throw()</code> statement solves this issue.</p>

<h4>
<a name="randomvector-this-p" class="anchor" href="#randomvector-this-p"><span class="octicon octicon-link"></span></a>RandomVector this-&gt;p</h4>

<p>Line 72 in <code>Mixture/RandomVector.h</code> references <code>p</code> "as is".</p>

<div class="highlight highlight-c++"><pre><span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">dim</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">k</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
    <span class="n">l</span> <span class="o">+=</span> <span class="n">log</span><span class="p">(</span><span class="n">Shark</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">x</span><span class="p">[</span> <span class="n">k</span> <span class="p">]),</span> <span class="mf">1e-100</span><span class="p">));</span>    <span class="c1">// !!!</span>
<span class="p">}</span>
</pre></div>

<p><code>p</code> is a public member function of <code>RandomVar</code> and <code>RandomVector</code> subclasses <code>RandomVar</code>.</p>

<div class="highlight highlight-c++"><pre><span class="c1">// RandomVar.h</span>
<span class="k">template</span> <span class="o">&lt;</span> <span class="k">class</span> <span class="nc">T</span> <span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">RandomVar</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="c1">// ***</span>
    <span class="k">virtual</span> <span class="kt">double</span> <span class="n">p</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// ***</span>
<span class="p">}</span>

<span class="c1">// RandomVector.h</span>
<span class="k">template</span> <span class="o">&lt;</span> <span class="k">class</span> <span class="nc">T</span> <span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">RandomVector</span> <span class="o">:</span> <span class="k">public</span> <span class="n">RandomVar</span><span class="o">&lt;</span> <span class="n">Array</span><span class="o">&lt;</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="o">&gt;</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="c1">// ***</span>
<span class="p">}</span>
</pre></div>

<p>Thus the fix is as simple as replacing reference to <code>p</code> with <code>this-&gt;p</code>. Note the triple exclamation mark comment in the original code (<code>// !!!</code>), looks like developers knew something could go wrong with this code.</p>

<h4>
<a name="make-it-static" class="anchor" href="#make-it-static"><span class="octicon octicon-link"></span></a>Make It Static</h4>

<p>The last patch is actually not a fix. Since we want to build a static library, we need to modify original <code>CMakeList.txt</code>, otherwise the dynamic library is built.</p>

<div class="highlight highlight-cmake"><pre><span class="nb">ADD_LIBRARY</span><span class="p">(</span> <span class="s">shark</span> <span class="s">STATIC</span> <span class="o">${</span><span class="nv">SRCS</span><span class="o">}</span> <span class="p">)</span>
</pre></div>

<p>If you want to build a dynamic (shared) library, you'll need to use the original line.</p>

<div class="highlight highlight-cmake"><pre><span class="nb">ADD_LIBRARY</span><span class="p">(</span> <span class="s">shark</span> <span class="s">SHARED</span> <span class="o">${</span><span class="nv">SRCS</span><span class="o">}</span> <span class="p">)</span>
</pre></div>

<h4>
<a name="apply-patch" class="anchor" href="#apply-patch"><span class="octicon octicon-link"></span></a>Apply Patch</h4>

<p>All the changes described above are available as a patch file <a href="https://github.com/mgrebenets/shark2-iosx/blob/master/shark.patch">shark.patch</a>.
To create patch file use <code>diff</code> utility.</p>

<div class="highlight highlight-bash"><pre>diff -crB shark_orig shark_patched &gt; shark.patch
</pre></div>

<p>To apply the patch use <code>patch</code> command.</p>

<div class="highlight highlight-bash"><pre>patch -d src/Shark -p1 --forward -r - -i ../../shark.patch
</pre></div>

<ul>
<li>The <code>--forward</code> flag will disable interactive mode and all the prompts</li>
<li>
<code>-d</code> flag is used to specify the source code folder, the utility will <code>cd</code> into specified folder</li>
<li>
<code>-r -</code> option specifies that no <code>.rej</code> files should be created if the patch is already applied (or in case of any other error)</li>
<li>note the relative path for <code>-i ../../shark.patch</code>, this is needed because <code>-d</code> flag is used and patch command will be executed in <code>src/Shark</code> folder</li>
</ul><h3>
<a name="configure-and-build" class="anchor" href="#configure-and-build"><span class="octicon octicon-link"></span></a>Configure and Build</h3>

<p>Now when all the compile errors are fixed it's time to build static library for all target platforms.</p>

<p>Before we run <code>make</code> we have to configure the build (that also creates <code>Makefile</code>) and for this purpose we're going to stick with <code>cmake</code>.</p>

<p>We'll have to run <code>cmake</code> and then <code>make</code> 3 times to build 3 static libraries for following targets</p>

<ul>
<li>iOS Devices (armv7, armv7s, x86_64)</li>
<li>iOS Simulator (i386, x86_64)</li>
<li>Mac OS X (x86_64)</li>
</ul><p>The libraries for iOS Device and Simulator will later be merged into one fat library which you can use for your iOS development and release.</p>

<h4>
<a name="cmake-basics" class="anchor" href="#cmake-basics"><span class="octicon octicon-link"></span></a>cmake Basics</h4>

<p>Each of the build targets needs to be configured differently with <code>cmake</code>.
The following options have to be configured:</p>

<ul>
<li>C++ Compiler (<code>CMAKE_CXX_COMPILER</code>)</li>
</ul><p>By default the <code>/usr/bin/c++</code> is used as C++ compiler, but we want to build using <code>clang++</code> compiler from Xcode toolchain.</p>

<ul>
<li>C++ Compiler Flags (<code>CMAKE_CXX_FLAGS</code>)</li>
</ul><p>The C++ compiler flags are used to specify target architectures and other important build settings.</p>

<ul>
<li>C Compiler (<code>CMAKE_C_COMPILER</code>)</li>
</ul><p>Even though there's no plain C code, the C compiler needs to be configured, since the whole project by default is C/C++ project.</p>

<ul>
<li>System Root (<code>CMAKE_OSX_SYSROOT</code>)</li>
</ul><p>This is where build system will look for all the standard library includes.</p>

<ul>
<li>Install Prefix (<code>CMAKE_INSTALL_PREFIX</code>)</li>
</ul><p>This is optional, the prefix is used to tell <code>make install</code> where to install your library. Normally it's used when you build a shared library and then want to place it somewhere in your <code>/usr/local/lib</code>.</p>

<ul>
<li>Build System Generator (<code>-G</code> flag)
We plan to use <code>make</code> utility with <code>Makefile</code>, so this option will be <code>"Unix Makefiles"</code>.</li>
</ul><h4>
<a name="xcode-toolchain" class="anchor" href="#xcode-toolchain"><span class="octicon octicon-link"></span></a>Xcode Toolchain</h4>

<p>Let's start with asking Xcode where all the tools are.</p>

<div class="highlight highlight-bash"><pre><span class="nv">XCODE_ROOT</span><span class="o">=</span><span class="k">$(</span>xcode-select -print-path<span class="k">)</span>
<span class="nv">XCODE_ARM_ROOT</span><span class="o">=</span><span class="nv">$XCODE_ROOT</span>/Platforms/iPhoneOS.platform/Developer
<span class="nv">XCODE_SIM_ROOT</span><span class="o">=</span><span class="nv">$XCODE_ROOT</span>/Platforms/iPhoneSimulator.platform/Developer
<span class="nv">XCODE_TOOLCHAIN_BIN</span><span class="o">=</span><span class="nv">$XCODE_ROOT</span>/Toolchains/XcodeDefault.xctoolchain/usr/bin
<span class="nv">CXX_COMPILER</span><span class="o">=</span><span class="k">${</span><span class="nv">XCODE_TOOLCHAIN_BIN</span><span class="k">}</span>/clang++
<span class="nv">C_COMPILER</span><span class="o">=</span><span class="k">${</span><span class="nv">XCODE_TOOLCHAIN_BIN</span><span class="k">}</span>/clang
</pre></div>

<p>Now we have all we need: C and C++ compiler, system roots for iOS Device and Simulator. For OS X the <code>cmake</code> is smart enough to find system root automatically.</p>

<p>It's time to configure build for each target.</p>

<h5>
<a name="ios-device" class="anchor" href="#ios-device"><span class="octicon octicon-link"></span></a>iOS Device</h5>

<p>We don't want to mess up with the original source code, so let's build in a separate folder.</p>

<div class="highlight highlight-bash"><pre>mkdir -p build/ios
<span class="nb">cd </span>build/ios
</pre></div>

<p>To configure the build, we already have <code>CXX_COMPILER</code>, <code>C_COMPILER</code>. We still need to configure is C++ Compiler Flags and System Root.</p>

<p>Our goal is to support 3 iOS Device architectures: <code>armv7</code>, <code>armv7s</code> and <code>arm64</code>, that's where <code>-arch</code> option is used.</p>

<p>The System Root is the root folder of iPhone OS 7.0 SDK, it's located in the <code>XCODE_ARM_ROOT</code>, which we defined above.</p>

<div class="highlight highlight-bash"><pre><span class="nv">CXX_FLAGS</span><span class="o">=</span><span class="s2">"-arch armv7 -arch armv7s -arch arm64"</span>
<span class="nv">SYSTEM_ROOT</span><span class="o">=</span><span class="k">${</span><span class="nv">XCODE_ARM_ROOT</span><span class="k">}</span>/SDKs/iPhoneOS7.0.sdk
</pre></div>

<p>Now we can run <code>cmake</code>.</p>

<div class="highlight highlight-bash"><pre>cmake <span class="se">\</span>
  -DCMAKE_CXX_COMPILER<span class="o">=</span><span class="nv">$CXX_COMPILER</span> <span class="se">\</span>
  -DCMAKE_OSX_SYSROOT<span class="o">=</span><span class="s2">"$SYSTEM_ROOT"</span> <span class="se">\</span>
  -DCMAKE_C_COMPILER<span class="o">=</span><span class="nv">$C_COMPILER</span> <span class="se">\</span>
  -DCMAKE_CXX_FLAGS<span class="o">=</span><span class="s2">"$CXX_FLAGS"</span> <span class="se">\</span>
  -G <span class="s2">"Unix Makefiles"</span> <span class="se">\</span>
  ../../src/Shark
</pre></div>

<blockquote>
<p>If you are trying to run this command right now, you'll face the "C Compiler Test" error. For a work-around check the "cmake Tricks" section below.</p>
</blockquote>

<h5>
<a name="ios-simulator" class="anchor" href="#ios-simulator"><span class="octicon octicon-link"></span></a>iOS Simulator</h5>

<p>For iOS Simulator we're going to use <code>i386</code> and <code>x86_64</code> architectures, the latter one will allow you to test on "iPad Retina (64-bit)" and other 64-bit device simulators.</p>

<p>The System Root is <code>${XCODE_SIM_ROOT}/SDKs/iPhoneSimulator7.0.sdk</code>.</p>

<p>And then there's one more very important C++ compiler flag: <code>-mios-simulator-version-min=7.0</code>. If you don't set this flag, the build target will be OS X.</p>

<div class="highlight highlight-bash"><pre><span class="nv">CXX_FLAGS</span><span class="o">=</span><span class="s2">"-arch i386 -arch x86_64 -mios-simulator-version-min=7.0"</span>
<span class="nv">SYSTEM_ROOT</span><span class="o">=</span><span class="k">${</span><span class="nv">XCODE_SIM_ROOT</span><span class="k">}</span>/SDKs/iPhoneSimulator7.0.sdk

cmake <span class="se">\</span>
  -DCMAKE_CXX_COMPILER<span class="o">=</span><span class="nv">$CXX_COMPILER</span> <span class="se">\</span>
  -DCMAKE_OSX_SYSROOT<span class="o">=</span><span class="s2">"$SYSTEM_ROOT"</span> <span class="se">\</span>
  -DCMAKE_C_COMPILER<span class="o">=</span><span class="nv">$C_COMPILER</span> <span class="se">\</span>
  -DCMAKE_CXX_FLAGS<span class="o">=</span><span class="s2">"$CXX_FLAGS"</span> <span class="se">\</span>
  -G <span class="s2">"Unix Makefiles"</span> <span class="se">\</span>
  ../../src/Shark
</pre></div>

<h5>
<a name="mac-os-x" class="anchor" href="#mac-os-x"><span class="octicon octicon-link"></span></a>Mac OS X</h5>

<p>For OS X we only need to configure C and C++ compilers, then leave the rest of settings to <code>cmake</code>.</p>

<div class="highlight highlight-bash"><pre>cmake <span class="se">\</span>
  -DCMAKE_CXX_COMPILER<span class="o">=</span><span class="nv">$CXX_COMPILER</span> <span class="se">\</span>
  -DCMAKE_C_COMPILER<span class="o">=</span><span class="nv">$C_COMPILER</span> <span class="se">\</span>
  -G <span class="s2">"Unix Makefiles"</span> <span class="se">\</span>
  ../../src/Shark
</pre></div>

<h4>
<a name="cmake-tricks" class="anchor" href="#cmake-tricks"><span class="octicon octicon-link"></span></a>cmake Tricks</h4>

<h5>
<a name="compiler-test" class="anchor" href="#compiler-test"><span class="octicon octicon-link"></span></a>Compiler Test</h5>

<p>Now, if you tried to run any of the above commands you definitely face the "C Compiler Test" error. <code>cmake</code> checks <code>clang</code> compiler by trying to compile some test code and that check fails. I tried to use different approaches to pass the compiler test, such as setting project type to <code>NONE</code> in <code>CMakeLists.txt</code>, but nothing worked for me. So I had to come up with somewhat dirty trick to fix this problem:</p>

<ul>
<li>Run <code>cmake</code> once with no properties set and no generator option, aka "Initial Run"</li>
</ul><p>This will pick up default C and C++ compilers, pass the compiler test, create <code>CMakeCache.txt</code> and <code>CMakeFiles</code> folder. If you <code>cmake</code> again, the compiler test won't be performed any more.</p>

<h5>
<a name="changed-parameters" class="anchor" href="#changed-parameters"><span class="octicon octicon-link"></span></a>Changed Parameters</h5>

<p>If you just ran <code>cmake</code> for the 2nd time with all the properties set (compilers, system root, flags, etc.) you might think that you're good to go and can just <code>make</code> stuff.</p>

<p>But wait... Run <code>ccmake ../../src/Shark</code> and have a look at all the build settings. You'll notice that C++ Compiler Flags are not set. This is specifics of <code>cmake</code>. If you change some important build settings, like compiler flags, the <code>cmake</code> will detect the change and spit out a message like "C++ Compiler Flags changed, you need to configure build to apply the changes." Well, you won't see this message with <code>cmake</code>, but you can play around with <code>ccmake</code> and see it.</p>

<p>In short, you need to run <code>cmake</code> twice if you change some specific settings. That's why you'll see <code>cmakeRun</code> called twice in <code>build.sh</code> for iOS target. And yes, with the initial run to pass compiler test check, you'll end up calling <code>cmake</code> for up to 3 times.</p>

<h4>
<a name="make-it" class="anchor" href="#make-it"><span class="octicon octicon-link"></span></a>Make It!</h4>

<p>At last you're ready to make it!</p>

<p>At this point it is as simple as</p>

<div class="highlight highlight-bash"><pre>make -j16
</pre></div>

<p>The <code>-j16</code> will parallelize the build and make it way faster than plain <code>make</code>.</p>

<p>It doesn't take long and in the end you'll have <code>libshark.a</code> static library. Check it with <code>file</code> utility to make sure you have all the architectures in place.</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>file build/ios/libshark.a
build/ios/libshark.a: Mach-O universal binary with 3 architectures
build/ios/libshark.a <span class="o">(</span><span class="k">for </span>architecture armv7<span class="o">)</span>:  current ar archive random library
build/ios/libshark.a <span class="o">(</span><span class="k">for </span>architecture armv7s<span class="o">)</span>: current ar archive random library
build/ios/libshark.a <span class="o">(</span><span class="k">for </span>architecture cputype <span class="o">(</span>16777228<span class="o">)</span> cpusubtype <span class="o">(</span>0<span class="o">))</span>:  current ar archive random library

<span class="nv">$ </span>file build/sim/libshark.a
build/sim/libshark.a: Mach-O universal binary with 2 architectures
build/sim/libshark.a <span class="o">(</span><span class="k">for </span>architecture i386<span class="o">)</span>: current ar archive random library
build/sim/libshark.a <span class="o">(</span><span class="k">for </span>architecture x86_64<span class="o">)</span>: current ar archive random library

<span class="nv">$ </span>file build/osx/libshark.a
build/osx/libshark.a: current ar archive random library
</pre></div>

<h3>
<a name="lipo-library" class="anchor" href="#lipo-library"><span class="octicon octicon-link"></span></a>Lipo Library</h3>

<p>So you have a static library for iOS Devices and another one for iOS Simulator. To have the convenience of using same framework for device and simulator you need to merge these two static libraries into one.</p>

<p>The <code>lipo</code> utility is what you need.</p>

<div class="highlight highlight-bash"><pre>mkdir -p lib/ios
<span class="nv">$XCODE_TOOLCHAIN_BIN</span>/lipo -create build/ios/libshark.a build/sim/libshark.a -o lib/ios/libshark.a
</pre></div>

<p>Now run <code>file lib/ios/libshark.a</code> and make sure the fat library includes 5 architectures.</p>

<p>If you're targeting OS X, just copy <code>build/osx/libshark.a</code> to <code>lib/osx</code>. It only includes one x86_64 architecture.</p>

<h3>
<a name="package-framework" class="anchor" href="#package-framework"><span class="octicon octicon-link"></span></a>Package Framework</h3>

<p>It is time to nicely wrap the static library in a neat framework package.</p>

<p>There's plenty of guides how to do that using bash script. The general steps are described below.</p>

<h5>
<a name="create-framework-bundle" class="anchor" href="#create-framework-bundle"><span class="octicon octicon-link"></span></a>Create Framework Bundle</h5>

<p>Create the framework folder structure (bundle) with proper symbolic links. Name the framework folder as <code>Shark.framework</code></p>

<div class="highlight highlight-bash"><pre>Shark.framework/
├── Documentation -&gt; Versions/Current/Documentation
├── Headers -&gt; Versions/Current/Headers
├── Resources -&gt; Versions/Current/Resources
└── Versions
    ├── A
    │   ├── Documentation
    │   ├── Headers
    │   └── Resources
    └── Current -&gt; A
</pre></div>

<h5>
<a name="copy-static-library" class="anchor" href="#copy-static-library"><span class="octicon octicon-link"></span></a>Copy Static Library</h5>

<p>Rename static library to <code>Shark</code> and copy it into framework bundle</p>

<div class="highlight highlight-bash"><pre>cp build/ios/libshark.a Shark.framework/Versions/A/Shark
</pre></div>

<h5>
<a name="copy-headers" class="anchor" href="#copy-headers"><span class="octicon octicon-link"></span></a>Copy Headers</h5>

<p>Copy all the headers to framework bundle <code>Headers</code> folder.</p>

<p>Start with copying all the headers from <code>src/include</code> to framework bundle.
Then remove unused <code>statistics.h</code> header. If you check <code>CMakeLists.txt</code> in the source folder, you'll notice that there's no <code>INSTALL</code> rule for <code>statistics.h</code> header.</p>

<div class="highlight highlight-bash"><pre>cp -r src/Shark/include/* Shark.framework/Headers/
rm Shark.framework/Headers/statistics.h
</pre></div>

<h6>
<a name="patch-headers" class="anchor" href="#patch-headers"><span class="octicon octicon-link"></span></a>Patch Headers</h6>

<p>You might think "What's next step?" at this point, but there's some serious patching to be applied to header files.</p>

<p>If you just copy the headers "as is", you'll run into a number of nasty compile errors when including headers from the framework. While using a shared library and running on OS X I could apply some workaround for this issue using Header Search Path and other build settings, but that's not so easy when all the headers come from a framework bundle.</p>

<p>While trying to solve the problem I looked into another well known and well built library - <code>boost</code>. All (well, all that I've seen) the includes in the <code>boost</code> library follow the same convention: in the <code>#include</code> directive the header path starts with <code>boost/</code>, for example</p>

<div class="highlight highlight-c++"><pre><span class="cp">#include "boost/config.hpp"</span>
<span class="cp">#include &lt;boost/type_traits/remove_reference.hpp&gt;</span>
</pre></div>

<p>So I used <code>sed</code> to patch all the headers in the framework bundle. The patching does the following:</p>

<ul>
<li>Find all includes of <code>SharkDefs.h</code> and replace with <code>Shark/SharkDefs.h</code>
</li>
<li>Find all includes of library components and add <code>Shark/</code> to the include path.</li>
</ul><p>By components, I mean all the sub-folders in <code>Headers</code> folder:
<code>Array</code>, <code>Rng</code>, <code>LinAlg</code>, <code>FileUtil</code>, <code>EALib</code>, <code>MOO-EALib</code>, <code>ReClaM</code>, <code>Mixture</code>, <code>TimeSeries</code>, <code>Fuzzy</code>.</p>

<p>And then there was a number of bad-formed include statements like <code>#include&lt;SharkDefs.h&gt;</code> with no space after <code>#include</code>.</p>

<p>The bash script that does the job using <code>sed</code> with modern regular expression syntax and in-place edits.</p>

<div class="highlight highlight-bash"><pre><span class="c"># avoid invalid character sequence errors</span>
<span class="nb">export </span><span class="nv">LC_TYPE</span><span class="o">=</span>C
<span class="nb">export </span><span class="nv">LANG</span><span class="o">=</span>C

<span class="c"># fix missing spaces in include directives</span>
<span class="c"># fix include path for SharkDefs.h</span>
<span class="c"># fix include paths for all components</span>
<span class="c"># use -E for modern regex syntax and avoid those gnu vs non-gnu sed issues</span>
<span class="nv">components</span><span class="o">=</span><span class="s2">"Array|Rng|LinAlg|FileUtil|EALib|MOO-EALib|ReClaM|Mixture|TimeSeries|Fuzzy"</span>
find Shark.framework/Headers -type f -exec <span class="se">\</span>
    sed -E -i <span class="s1">''</span> <span class="se">\</span>
    -e <span class="s2">"s,#include([&lt;\"]),#include \1,g"</span> <span class="se">\</span>
    -e <span class="s2">"s,#include([ \t])([&lt;\"])(SharkDefs.h),#include\1\2Shark/\3,g"</span> <span class="se">\</span>
    -e <span class="s2">"s,#include([ \t])([&lt;\"])(${components}/),#include\1\2Shark/\3,g"</span> <span class="se">\</span>
    <span class="o">{}</span> +
</pre></div>

<h5>
<a name="create-infoplist" class="anchor" href="#create-infoplist"><span class="octicon octicon-link"></span></a>Create Info.plist</h5>

<p>The last step is to create <code>Info.plist</code> in <code>Shark.framework/Resources</code></p>

<div class="highlight highlight-bash"><pre><span class="nv">FRAMEWORK_NAME</span><span class="o">=</span>Shark
<span class="nv">FRAMEWORK_CURRENT_VERSION</span><span class="o">=</span>2.3.4

cat &gt; Shark.framework/Resources/Info.plist <span class="s">&lt;&lt;EOF</span>
<span class="s">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="s">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
<span class="s">&lt;plist version="1.0"&gt;</span>
<span class="s">&lt;dict&gt;</span>
<span class="s">    &lt;key&gt;CFBundleDevelopmentRegion&lt;/key&gt;</span>
<span class="s">    &lt;string&gt;English&lt;/string&gt;</span>
<span class="s">    &lt;key&gt;CFBundleExecutable&lt;/key&gt;</span>
<span class="s">    &lt;string&gt;${FRAMEWORK_NAME}&lt;/string&gt;</span>
<span class="s">    &lt;key&gt;CFBundleIdentifier&lt;/key&gt;</span>
<span class="s">    &lt;string&gt;dk.diku.image&lt;/string&gt;</span>
<span class="s">    &lt;key&gt;CFBundleInfoDictionaryVersion&lt;/key&gt;</span>
<span class="s">    &lt;string&gt;6.0&lt;/string&gt;</span>
<span class="s">    &lt;key&gt;CFBundlePackageType&lt;/key&gt;</span>
<span class="s">    &lt;string&gt;FMWK&lt;/string&gt;</span>
<span class="s">    &lt;key&gt;CFBundleSignature&lt;/key&gt;</span>
<span class="s">    &lt;string&gt;????&lt;/string&gt;</span>
<span class="s">    &lt;key&gt;CFBundleVersion&lt;/key&gt;</span>
<span class="s">    &lt;string&gt;${FRAMEWORK_CURRENT_VERSION}&lt;/string&gt;</span>
<span class="s">&lt;/dict&gt;</span>
<span class="s">&lt;/plist&gt;</span>
<span class="s">EOF</span>
</pre></div>

<h2>
<a name="conclusion" class="anchor" href="#conclusion"><span class="octicon octicon-link"></span></a>Conclusion</h2>

<p>That's it!</p>

<p>Drag &amp; drop the framework into your Xcode project and start coding.</p>

<p>As an improvement, I'm considering creating a <a href="cocoapods.org">CocoaPods</a> pods for iOS and OSX version of the framework, so no need for stone age drag &amp; drop thing.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Shark2-iosx maintained by <a href="https://github.com/mgrebenets">mgrebenets</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
